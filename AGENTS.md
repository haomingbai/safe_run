# AGENTS.md

## 目标

本仓库的 AI 代理在编写代码或文档时，必须严格基于 `plan/` 设计文档执行，禁止脱离设计臆造实现、接口或结论。

## 唯一事实来源（按优先级）

1. `plan/OVERVIEW.md`
2. `plan/INTERFACE_BASELINE.md`
3. 对应阶段文档：`plan/M0` 到 `plan/M4` 下的 `OVERVIEW.md`、`MODULES.md`、`INTERFACES.md`、`ARCHITECTURE.md`、`REFERENCES.md`
4. `DRAFT.md`（仅作为背景，不得覆盖 `plan/` 已定稿约束）
5. `TODO.md`（仅作为执行分解与进度跟踪参考，不得覆盖 `plan/` 约束）

若文档冲突，按以上顺序处理；无法消解时，先提问，不得自行假设。

## 强制执行流程（每次任务都要做）

1. 识别任务所属阶段（M0-M4）。
2. 至少阅读：
   - 全局：`plan/OVERVIEW.md`、`plan/INTERFACE_BASELINE.md`
   - 阶段：对应 `plan/Mx/*.md`
   - 若存在：项目根目录 `TODO.md`（用于识别未完成任务与依赖顺序）
3. 提取本次任务的约束清单（模块边界、接口字段、错误码、阶段能力）。
4. 再开始编码/写文档。
5. 输出结果时，标注依据文档路径（至少列出关键来源）。

## 阶段能力边界（不得越权）

- M0：只允许 `validate` + `compile --dry-run`，不得进入真实 microVM 执行。
- M1：最小执行闭环，网络固定 `none`。
- M2：强化挂载与路径安全；仍不得引入联网能力。
- M3：才允许 `network.mode=allowlist` 与 `networkPlan` 实际生效。
- M4：以交付、验证、归档为主，不新增高风险底层能力。

## 接口与兼容性硬约束

- 必须遵循接口基线：`I-PL-001`、`I-VA-001`、`I-CP-001`、`I-RN-001`、`I-EV-001`、`I-RP-001`、`I-VF-001`。
- 只允许增量兼容（additive change），禁止删除/重命名已发布字段。
- `PolicySpec` 与 `RunReport` 版本字段必须保留并正确使用。
- 任何接口语义变更都必须先更新 `plan/` 设计文档并获得确认，再改代码。

## 模块边界硬约束

- 仅在已定义模块职责内实现：`sr-policy`、`sr-compiler`、`sr-runner`、`sr-evidence`、`sr-cli`、`sr-ops`（及文档中允许的共享模块）。
- 禁止跨模块塞入不属于该模块的职责。
- 新增模块名或重划分模块职责，必须先更新设计文档并确认。

## 文档编写硬约束

- 文档结论必须可追溯到 `plan/` 中的具体文件。
- 不得写“猜测性设计”或“未来可能行为”作为既定事实。
- 若设计文档未覆盖该点，必须显式标记“待确认”，并向用户提问。

## 代码编写硬约束

- 禁止实现未在当前阶段定义的能力。
- 禁止绕过策略引擎、校验链和证据链要求。
- 错误码命名空间必须符合基线：`SR-POL-*`、`SR-CMP-*`、`SR-RUN-*`、`SR-EVD-*`、`SR-OPS-*`。
- 涉及策略、编译、执行、报告字段时，必须与接口文档逐项对齐。

## 代码结构与注释规范（强制）

- 单文件职责必须单一，避免跨模块混杂。
- 单文件不得超过 1000 行；如逼近上限，必须拆分子模块。
- 单函数不得超过 50 行；如确需超过，必须在函数注释中说明原因与不可拆分点。
- 必须为公共函数与关键逻辑编写清晰注释：
  - 注释需明确函数功能。
  - 注释需说明实现细节（关键步骤/关键边界）。

## 变更前后检查清单

在提交任何代码/文档前，必须自检：

- [ ] 已读取全局与对应阶段文档
- [ ] 变更未突破阶段能力边界
- [ ] 变更未破坏接口兼容性（仅 additive）
- [ ] 模块职责未漂移
- [ ] 输出中已给出依据文档路径
- [ ] 若存在未定义项，已显式标注并提问

## 违规处理

发现需求与设计不一致时：

1. 停止直接实现。
2. 列出冲突点与受影响文档路径。
3. 提出最小设计变更建议。
4. 等待确认后再继续编码/写文档。

## TODO 协同要求（复杂任务）

- 若根目录存在 `TODO.md`，执行前必须先读取，执行后必须更新对应任务勾选状态。
- `TODO.md` 仅用于任务拆解、顺序和进度，不得作为接口语义或阶段能力的事实来源。
- 若 `TODO.md` 与 `plan/` 冲突，以 `plan/` 为准，并按“违规处理”流程先提问。
